require "../../support/syntax"

private def it_lexes(string, type, *, slash_is_regex : Bool? = nil)
  it "lexes #{string.inspect}" do
    lexer = Lexer.new string
    unless (v = slash_is_regex).nil?
      lexer.slash_is_regex = v
    end
    token = lexer.next_token
    token.type.should eq(type)
  end
end

private def it_lexes(string, type, value)
  it "lexes #{string.inspect} as #{type} (#{value})" do
    lexer = Lexer.new string
    token = lexer.next_token
    token.type.should eq(type)
    token.value.should eq(value)
  end
end

private def it_lexes(string, type, value, number_kind)
  it "lexes #{string.inspect} as #{number_kind} (#{value})" do
    lexer = Lexer.new string
    token = lexer.next_token
    token.type.should eq(type)
    token.value.should eq(value)
    token.number_kind.should eq(number_kind)
  end
end

private def it_lexes_many(values, type)
  values.each do |value|
    it_lexes value, type, value
  end
end

private def it_lexes_keywords(keywords)
  keywords.each do |keyword|
    it_lexes keyword.to_s, :IDENT, keyword
  end
end

private def it_lexes_idents(idents)
  idents.each do |ident|
    it_lexes ident, :IDENT, ident
  end
end

private def it_lexes_i32(values)
  values.each { |value| it_lexes_number :i32, value }
end

private def it_lexes_i64(values)
  values.each { |value| it_lexes_number :i64, value }
end

private def it_lexes_i128(values)
  values.each { |value| it_lexes_number :i128, value }
end

private def it_lexes_u64(values)
  values.each { |value| it_lexes_number :u64, value }
end

private def it_lexes_f32(values)
  values.each { |value| it_lexes_number :f32, value }
end

private def it_lexes_f64(values)
  values.each { |value| it_lexes_number :f64, value }
end

private def it_lexes_number(number_kind, value : Array)
  it_lexes value[0], :NUMBER, value[1], number_kind
end

private def it_lexes_number(number_kind, value : String)
  it_lexes value, :NUMBER, value, number_kind
end

NUM = {
  10 => {
    "-1000000000000000000000000000000000000000" => "-1000000000000000000000000000000000000000",
    "-999999999999999999999999999999999999999"  => "-999999999999999999999999999999999999999",
    "-2**128 - 1"                               => "-340282366920938463463374607431768211457",
    "-2**128"                                   => "-340282366920938463463374607431768211456",
    "-2**128 + 1"                               => "-340282366920938463463374607431768211455",
    "-2**127 - 1"                               => "-170141183460469231731687303715884105729",
    "-2**127"                                   => "-170141183460469231731687303715884105728",
    "-2**127 + 1"                               => "-170141183460469231731687303715884105727",
    "-100000000000000000000000000000000000000"  => "-100000000000000000000000000000000000000",
    "-99999999999999999999999999999999999999"   => "-99999999999999999999999999999999999999",
    "-100000000000000000000"                    => "-100000000000000000000",
    "-99999999999999999999"                     => "-99999999999999999999",
    "-2**64 - 1"                                => "-18446744073709551617",
    "-2**64"                                    => "-18446744073709551616",
    "-2**64 + 1"                                => "-18446744073709551615",
    "-10000000000000000000"                     => "-10000000000000000000",
    "-9999999999999999999"                      => "-9999999999999999999",
    "-2**63 - 1"                                => "-9223372036854775809",
    "-2**63"                                    => "-9223372036854775808",
    "-2**63 + 1"                                => "-9223372036854775807",
    "-1000000000000000000"                      => "-1000000000000000000",
    "-999999999999999999"                       => "-999999999999999999",
    "-10000000000"                              => "-10000000000",
    "-9999999999"                               => "-9999999999",
    "-2**32 - 1"                                => "-4294967297",
    "-2**32"                                    => "-4294967296",
    "-2**32 + 1"                                => "-4294967295",
    "-2**31 - 1"                                => "-2147483649",
    "-2**31"                                    => "-2147483648",
    "-2**31 + 1"                                => "-2147483647",
    "-1000000000"                               => "-1000000000",
    "-999999999"                                => "-999999999",
    "-2**16 - 1"                                => "-65537",
    "-2**16"                                    => "-65536",
    "-2**16 + 1"                                => "-65535",
    "-2**15 - 1"                                => "-32769",
    "-2**15"                                    => "-32768",
    "-2**15 + 1"                                => "-32767",
    "-2**8 - 1"                                 => "-257",
    "-2**8"                                     => "-256",
    "-2**8 + 1"                                 => "-255",
    "-2**7 - 1"                                 => "-129",
    "-2**7"                                     => "-128",
    "-2**7 + 1"                                 => "-127",
    "-1"                                        => "-1",
    "0"                                         => "0",
    "1"                                         => "1",
    "2**7 - 1"                                  => "127",
    "2**7"                                      => "128",
    "2**7 + 1"                                  => "129",
    "2**8 - 1"                                  => "255",
    "2**8"                                      => "256",
    "2**8 + 1"                                  => "257",
    "2**15 - 1"                                 => "32767",
    "2**15"                                     => "32768",
    "2**15 + 1"                                 => "32769",
    "2**16 - 1"                                 => "65535",
    "2**16"                                     => "65536",
    "2**16 + 1"                                 => "65537",
    "999999999"                                 => "999999999",
    "1000000000"                                => "1000000000",
    "2**31 - 1"                                 => "2147483647",
    "2**31"                                     => "2147483648",
    "2**31 + 1"                                 => "2147483649",
    "2**32 - 1"                                 => "4294967295",
    "2**32"                                     => "4294967296",
    "2**32 + 1"                                 => "4294967297",
    "9999999999"                                => "9999999999",
    "10000000000"                               => "10000000000",
    "999999999999999999"                        => "999999999999999999",
    "1000000000000000000"                       => "1000000000000000000",
    "2**63 - 1"                                 => "9223372036854775807",
    "2**63"                                     => "9223372036854775808",
    "2**63 + 1"                                 => "9223372036854775809",
    "9999999999999999999"                       => "9999999999999999999",
    "10000000000000000000"                      => "10000000000000000000",
    "2**64 - 1"                                 => "18446744073709551615",
    "2**64"                                     => "18446744073709551616",
    "2**64 + 1"                                 => "18446744073709551617",
    "99999999999999999999"                      => "99999999999999999999",
    "100000000000000000000"                     => "100000000000000000000",
    "99999999999999999999999999999999999999"    => "99999999999999999999999999999999999999",
    "100000000000000000000000000000000000000"   => "100000000000000000000000000000000000000",
    "2**127 - 1"                                => "170141183460469231731687303715884105727",
    "2**127"                                    => "170141183460469231731687303715884105728",
    "2**127 + 1"                                => "170141183460469231731687303715884105729",
    "2**128 - 1"                                => "340282366920938463463374607431768211455",
    "2**128"                                    => "340282366920938463463374607431768211456",
    "2**128 + 1"                                => "340282366920938463463374607431768211457",
    "999999999999999999999999999999999999999"   => "999999999999999999999999999999999999999",
    "1000000000000000000000000000000000000000"  => "1000000000000000000000000000000000000000",
  },
  16 => {
    "-1000000000000000000000000000000000000000" => "-0x2f050fe938943acc45f65568000000000",
    "-999999999999999999999999999999999999999"  => "-0x2f050fe938943acc45f65567fffffffff",
    "-2**128 - 1"                               => "-0x100000000000000000000000000000001",
    "-2**128"                                   => "-0x100000000000000000000000000000000",
    "-2**128 + 1"                               => "-0xffffffffffffffffffffffffffffffff",
    "-2**127 - 1"                               => "-0x80000000000000000000000000000001",
    "-2**127"                                   => "-0x80000000000000000000000000000000",
    "-2**127 + 1"                               => "-0x7fffffffffffffffffffffffffffffff",
    "-100000000000000000000000000000000000000"  => "-0x4b3b4ca85a86c47a098a224000000000",
    "-99999999999999999999999999999999999999"   => "-0x4b3b4ca85a86c47a098a223fffffffff",
    "-100000000000000000000"                    => "-0x56bc75e2d63100000",
    "-99999999999999999999"                     => "-0x56bc75e2d630fffff",
    "-2**64 - 1"                                => "-0x10000000000000001",
    "-2**64"                                    => "-0x10000000000000000",
    "-2**64 + 1"                                => "-0xffffffffffffffff",
    "-10000000000000000000"                     => "-0x8ac7230489e80000",
    "-9999999999999999999"                      => "-0x8ac7230489e7ffff",
    "-2**63 - 1"                                => "-0x8000000000000001",
    "-2**63"                                    => "-0x8000000000000000",
    "-2**63 + 1"                                => "-0x7fffffffffffffff",
    "-1000000000000000000"                      => "-0xde0b6b3a7640000",
    "-999999999999999999"                       => "-0xde0b6b3a763ffff",
    "-10000000000"                              => "-0x2540be400",
    "-9999999999"                               => "-0x2540be3ff",
    "-2**32 - 1"                                => "-0x100000001",
    "-2**32"                                    => "-0x100000000",
    "-2**32 + 1"                                => "-0xffffffff",
    "-2**31 - 1"                                => "-0x80000001",
    "-2**31"                                    => "-0x80000000",
    "-2**31 + 1"                                => "-0x7fffffff",
    "-1000000000"                               => "-0x3b9aca00",
    "-999999999"                                => "-0x3b9ac9ff",
    "-2**16 - 1"                                => "-0x10001",
    "-2**16"                                    => "-0x10000",
    "-2**16 + 1"                                => "-0xffff",
    "-2**15 - 1"                                => "-0x8001",
    "-2**15"                                    => "-0x8000",
    "-2**15 + 1"                                => "-0x7fff",
    "-2**8 - 1"                                 => "-0x101",
    "-2**8"                                     => "-0x100",
    "-2**8 + 1"                                 => "-0xff",
    "-2**7 - 1"                                 => "-0x81",
    "-2**7"                                     => "-0x80",
    "-2**7 + 1"                                 => "-0x7f",
    "-1"                                        => "-0x1",
    "0"                                         => "0x0",
    "1"                                         => "0x1",
    "2**7 - 1"                                  => "0x7f",
    "2**7"                                      => "0x80",
    "2**7 + 1"                                  => "0x81",
    "2**8 - 1"                                  => "0xff",
    "2**8"                                      => "0x100",
    "2**8 + 1"                                  => "0x101",
    "2**15 - 1"                                 => "0x7fff",
    "2**15"                                     => "0x8000",
    "2**15 + 1"                                 => "0x8001",
    "2**16 - 1"                                 => "0xffff",
    "2**16"                                     => "0x10000",
    "2**16 + 1"                                 => "0x10001",
    "999999999"                                 => "0x3b9ac9ff",
    "1000000000"                                => "0x3b9aca00",
    "2**31 - 1"                                 => "0x7fffffff",
    "2**31"                                     => "0x80000000",
    "2**31 + 1"                                 => "0x80000001",
    "2**32 - 1"                                 => "0xffffffff",
    "2**32"                                     => "0x100000000",
    "2**32 + 1"                                 => "0x100000001",
    "9999999999"                                => "0x2540be3ff",
    "10000000000"                               => "0x2540be400",
    "999999999999999999"                        => "0xde0b6b3a763ffff",
    "1000000000000000000"                       => "0xde0b6b3a7640000",
    "2**63 - 1"                                 => "0x7fffffffffffffff",
    "2**63"                                     => "0x8000000000000000",
    "2**63 + 1"                                 => "0x8000000000000001",
    "9999999999999999999"                       => "0x8ac7230489e7ffff",
    "10000000000000000000"                      => "0x8ac7230489e80000",
    "2**64 - 1"                                 => "0xffffffffffffffff",
    "2**64"                                     => "0x10000000000000000",
    "2**64 + 1"                                 => "0x10000000000000001",
    "99999999999999999999"                      => "0x56bc75e2d630fffff",
    "100000000000000000000"                     => "0x56bc75e2d63100000",
    "99999999999999999999999999999999999999"    => "0x4b3b4ca85a86c47a098a223fffffffff",
    "100000000000000000000000000000000000000"   => "0x4b3b4ca85a86c47a098a224000000000",
    "2**127 - 1"                                => "0x7fffffffffffffffffffffffffffffff",
    "2**127"                                    => "0x80000000000000000000000000000000",
    "2**127 + 1"                                => "0x80000000000000000000000000000001",
    "2**128 - 1"                                => "0xffffffffffffffffffffffffffffffff",
    "2**128"                                    => "0x100000000000000000000000000000000",
    "2**128 + 1"                                => "0x100000000000000000000000000000001",
    "999999999999999999999999999999999999999"   => "0x2f050fe938943acc45f65567fffffffff",
    "1000000000000000000000000000000000000000"  => "0x2f050fe938943acc45f65568000000000",
  },
  8 => {
    "-1000000000000000000000000000000000000000" => "-0o13602417722342241654610575452550000000000000",
    "-999999999999999999999999999999999999999"  => "-0o13602417722342241654610575452547777777777777",
    "-2**128 - 1"                               => "-0o4000000000000000000000000000000000000000001",
    "-2**128"                                   => "-0o4000000000000000000000000000000000000000000",
    "-2**128 + 1"                               => "-0o3777777777777777777777777777777777777777777",
    "-2**127 - 1"                               => "-0o2000000000000000000000000000000000000000001",
    "-2**127"                                   => "-0o2000000000000000000000000000000000000000000",
    "-2**127 + 1"                               => "-0o1777777777777777777777777777777777777777777",
    "-100000000000000000000000000000000000000"  => "-0o1131664625026503304364046121044000000000000",
    "-99999999999999999999999999999999999999"   => "-0o1131664625026503304364046121043777777777777",
    "-100000000000000000000"                    => "-0o12657072742654304000000",
    "-99999999999999999999"                     => "-0o12657072742654303777777",
    "-2**64 - 1"                                => "-0o2000000000000000000001",
    "-2**64"                                    => "-0o2000000000000000000000",
    "-2**64 + 1"                                => "-0o1777777777777777777777",
    "-10000000000000000000"                     => "-0o1053071060221172000000",
    "-9999999999999999999"                      => "-0o1053071060221171777777",
    "-2**63 - 1"                                => "-0o1000000000000000000001",
    "-2**63"                                    => "-0o1000000000000000000000",
    "-2**63 + 1"                                => "-0o777777777777777777777",
    "-1000000000000000000"                      => "-0o67405553164731000000",
    "-999999999999999999"                       => "-0o67405553164730777777",
    "-10000000000"                              => "-0o112402762000",
    "-9999999999"                               => "-0o112402761777",
    "-2**32 - 1"                                => "-0o40000000001",
    "-2**32"                                    => "-0o40000000000",
    "-2**32 + 1"                                => "-0o37777777777",
    "-2**31 - 1"                                => "-0o20000000001",
    "-2**31"                                    => "-0o20000000000",
    "-2**31 + 1"                                => "-0o17777777777",
    "-1000000000"                               => "-0o7346545000",
    "-999999999"                                => "-0o7346544777",
    "-2**16 - 1"                                => "-0o200001",
    "-2**16"                                    => "-0o200000",
    "-2**16 + 1"                                => "-0o177777",
    "-2**15 - 1"                                => "-0o100001",
    "-2**15"                                    => "-0o100000",
    "-2**15 + 1"                                => "-0o77777",
    "-2**8 - 1"                                 => "-0o401",
    "-2**8"                                     => "-0o400",
    "-2**8 + 1"                                 => "-0o377",
    "-2**7 - 1"                                 => "-0o201",
    "-2**7"                                     => "-0o200",
    "-2**7 + 1"                                 => "-0o177",
    "-1"                                        => "-0o1",
    "0"                                         => "0o0",
    "1"                                         => "0o1",
    "2**7 - 1"                                  => "0o177",
    "2**7"                                      => "0o200",
    "2**7 + 1"                                  => "0o201",
    "2**8 - 1"                                  => "0o377",
    "2**8"                                      => "0o400",
    "2**8 + 1"                                  => "0o401",
    "2**15 - 1"                                 => "0o77777",
    "2**15"                                     => "0o100000",
    "2**15 + 1"                                 => "0o100001",
    "2**16 - 1"                                 => "0o177777",
    "2**16"                                     => "0o200000",
    "2**16 + 1"                                 => "0o200001",
    "999999999"                                 => "0o7346544777",
    "1000000000"                                => "0o7346545000",
    "2**31 - 1"                                 => "0o17777777777",
    "2**31"                                     => "0o20000000000",
    "2**31 + 1"                                 => "0o20000000001",
    "2**32 - 1"                                 => "0o37777777777",
    "2**32"                                     => "0o40000000000",
    "2**32 + 1"                                 => "0o40000000001",
    "9999999999"                                => "0o112402761777",
    "10000000000"                               => "0o112402762000",
    "999999999999999999"                        => "0o67405553164730777777",
    "1000000000000000000"                       => "0o67405553164731000000",
    "2**63 - 1"                                 => "0o777777777777777777777",
    "2**63"                                     => "0o1000000000000000000000",
    "2**63 + 1"                                 => "0o1000000000000000000001",
    "9999999999999999999"                       => "0o1053071060221171777777",
    "10000000000000000000"                      => "0o1053071060221172000000",
    "2**64 - 1"                                 => "0o1777777777777777777777",
    "2**64"                                     => "0o2000000000000000000000",
    "2**64 + 1"                                 => "0o2000000000000000000001",
    "99999999999999999999"                      => "0o12657072742654303777777",
    "100000000000000000000"                     => "0o12657072742654304000000",
    "99999999999999999999999999999999999999"    => "0o1131664625026503304364046121043777777777777",
    "100000000000000000000000000000000000000"   => "0o1131664625026503304364046121044000000000000",
    "2**127 - 1"                                => "0o1777777777777777777777777777777777777777777",
    "2**127"                                    => "0o2000000000000000000000000000000000000000000",
    "2**127 + 1"                                => "0o2000000000000000000000000000000000000000001",
    "2**128 - 1"                                => "0o3777777777777777777777777777777777777777777",
    "2**128"                                    => "0o4000000000000000000000000000000000000000000",
    "2**128 + 1"                                => "0o4000000000000000000000000000000000000000001",
    "999999999999999999999999999999999999999"   => "0o13602417722342241654610575452547777777777777",
    "1000000000000000000000000000000000000000"  => "0o13602417722342241654610575452550000000000000",
  },
  2 => {
    "-1000000000000000000000000000000000000000" => "-0b1011110000010100001111111010010011100010010100001110101100110001000101111101100101010101101000000000000000000000000000000000000000",
    "-999999999999999999999999999999999999999"  => "-0b1011110000010100001111111010010011100010010100001110101100110001000101111101100101010101100111111111111111111111111111111111111111",
    "-2**128 - 1"                               => "-0b100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001",
    "-2**128"                                   => "-0b100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
    "-2**128 + 1"                               => "-0b11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111",
    "-2**127 - 1"                               => "-0b10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001",
    "-2**127"                                   => "-0b10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
    "-2**127 + 1"                               => "-0b1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111",
    "-100000000000000000000000000000000000000"  => "-0b1001011001110110100110010101000010110101000011011000100011110100000100110001010001000100100000000000000000000000000000000000000",
    "-99999999999999999999999999999999999999"   => "-0b1001011001110110100110010101000010110101000011011000100011110100000100110001010001000100011111111111111111111111111111111111111",
    "-100000000000000000000"                    => "-0b1010110101111000111010111100010110101100011000100000000000000000000",
    "-99999999999999999999"                     => "-0b1010110101111000111010111100010110101100011000011111111111111111111",
    "-2**64 - 1"                                => "-0b10000000000000000000000000000000000000000000000000000000000000001",
    "-2**64"                                    => "-0b10000000000000000000000000000000000000000000000000000000000000000",
    "-2**64 + 1"                                => "-0b1111111111111111111111111111111111111111111111111111111111111111",
    "-10000000000000000000"                     => "-0b1000101011000111001000110000010010001001111010000000000000000000",
    "-9999999999999999999"                      => "-0b1000101011000111001000110000010010001001111001111111111111111111",
    "-2**63 - 1"                                => "-0b1000000000000000000000000000000000000000000000000000000000000001",
    "-2**63"                                    => "-0b1000000000000000000000000000000000000000000000000000000000000000",
    "-2**63 + 1"                                => "-0b111111111111111111111111111111111111111111111111111111111111111",
    "-1000000000000000000"                      => "-0b110111100000101101101011001110100111011001000000000000000000",
    "-999999999999999999"                       => "-0b110111100000101101101011001110100111011000111111111111111111",
    "-10000000000"                              => "-0b1001010100000010111110010000000000",
    "-9999999999"                               => "-0b1001010100000010111110001111111111",
    "-2**32 - 1"                                => "-0b100000000000000000000000000000001",
    "-2**32"                                    => "-0b100000000000000000000000000000000",
    "-2**32 + 1"                                => "-0b11111111111111111111111111111111",
    "-2**31 - 1"                                => "-0b10000000000000000000000000000001",
    "-2**31"                                    => "-0b10000000000000000000000000000000",
    "-2**31 + 1"                                => "-0b1111111111111111111111111111111",
    "-1000000000"                               => "-0b111011100110101100101000000000",
    "-999999999"                                => "-0b111011100110101100100111111111",
    "-2**16 - 1"                                => "-0b10000000000000001",
    "-2**16"                                    => "-0b10000000000000000",
    "-2**16 + 1"                                => "-0b1111111111111111",
    "-2**15 - 1"                                => "-0b1000000000000001",
    "-2**15"                                    => "-0b1000000000000000",
    "-2**15 + 1"                                => "-0b111111111111111",
    "-2**8 - 1"                                 => "-0b100000001",
    "-2**8"                                     => "-0b100000000",
    "-2**8 + 1"                                 => "-0b11111111",
    "-2**7 - 1"                                 => "-0b10000001",
    "-2**7"                                     => "-0b10000000",
    "-2**7 + 1"                                 => "-0b1111111",
    "-1"                                        => "-0b1",
    "0"                                         => "0b0",
    "1"                                         => "0b1",
    "2**7 - 1"                                  => "0b1111111",
    "2**7"                                      => "0b10000000",
    "2**7 + 1"                                  => "0b10000001",
    "2**8 - 1"                                  => "0b11111111",
    "2**8"                                      => "0b100000000",
    "2**8 + 1"                                  => "0b100000001",
    "2**15 - 1"                                 => "0b111111111111111",
    "2**15"                                     => "0b1000000000000000",
    "2**15 + 1"                                 => "0b1000000000000001",
    "2**16 - 1"                                 => "0b1111111111111111",
    "2**16"                                     => "0b10000000000000000",
    "2**16 + 1"                                 => "0b10000000000000001",
    "999999999"                                 => "0b111011100110101100100111111111",
    "1000000000"                                => "0b111011100110101100101000000000",
    "2**31 - 1"                                 => "0b1111111111111111111111111111111",
    "2**31"                                     => "0b10000000000000000000000000000000",
    "2**31 + 1"                                 => "0b10000000000000000000000000000001",
    "2**32 - 1"                                 => "0b11111111111111111111111111111111",
    "2**32"                                     => "0b100000000000000000000000000000000",
    "2**32 + 1"                                 => "0b100000000000000000000000000000001",
    "9999999999"                                => "0b1001010100000010111110001111111111",
    "10000000000"                               => "0b1001010100000010111110010000000000",
    "999999999999999999"                        => "0b110111100000101101101011001110100111011000111111111111111111",
    "1000000000000000000"                       => "0b110111100000101101101011001110100111011001000000000000000000",
    "2**63 - 1"                                 => "0b111111111111111111111111111111111111111111111111111111111111111",
    "2**63"                                     => "0b1000000000000000000000000000000000000000000000000000000000000000",
    "2**63 + 1"                                 => "0b1000000000000000000000000000000000000000000000000000000000000001",
    "9999999999999999999"                       => "0b1000101011000111001000110000010010001001111001111111111111111111",
    "10000000000000000000"                      => "0b1000101011000111001000110000010010001001111010000000000000000000",
    "2**64 - 1"                                 => "0b1111111111111111111111111111111111111111111111111111111111111111",
    "2**64"                                     => "0b10000000000000000000000000000000000000000000000000000000000000000",
    "2**64 + 1"                                 => "0b10000000000000000000000000000000000000000000000000000000000000001",
    "99999999999999999999"                      => "0b1010110101111000111010111100010110101100011000011111111111111111111",
    "100000000000000000000"                     => "0b1010110101111000111010111100010110101100011000100000000000000000000",
    "99999999999999999999999999999999999999"    => "0b1001011001110110100110010101000010110101000011011000100011110100000100110001010001000100011111111111111111111111111111111111111",
    "100000000000000000000000000000000000000"   => "0b1001011001110110100110010101000010110101000011011000100011110100000100110001010001000100100000000000000000000000000000000000000",
    "2**127 - 1"                                => "0b1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111",
    "2**127"                                    => "0b10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
    "2**127 + 1"                                => "0b10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001",
    "2**128 - 1"                                => "0b11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111",
    "2**128"                                    => "0b100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
    "2**128 + 1"                                => "0b100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001",
    "999999999999999999999999999999999999999"   => "0b1011110000010100001111111010010011100010010100001110101100110001000101111101100101010101100111111111111111111111111111111111111111",
    "1000000000000000000000000000000000000000"  => "0b1011110000010100001111111010010011100010010100001110101100110001000101111101100101010101101000000000000000000000000000000000000000",
  },
}

def test_cases(suffix : String, cases : Array({String?, String?, String | Symbol}))
  describe suffix do
    NUM.each_value do |items|
      exprs = items.keys
      cases.each do |range_begin, range_end, outcome|
        exprs[(range_begin ? exprs.index(range_begin).not_nil! : 0)..(range_end ? exprs.index(range_end).not_nil! : -1)].each do |expr|
          item = items[expr] + suffix
          if outcome.is_a?(Symbol)
            it_lexes_number outcome, [item, NUM[10][expr]]
          else
            assert_syntax_error item, outcome.gsub("{}", items[expr])
          end
        end
      end
    end
  end
end

describe "all", focus: true do
  test_cases("", [
    {nil, "-2**127 - 1", "{} doesn't fit in an Int64"},
    {"-2**127", "-2**63 - 1", "{} doesn't fit in an Int64, try using the suffix i128"},
    {"-2**63", "-2**31 - 1", :i64},
    {"-2**31", "2**31 - 1", :i32},
    {"2**31", "2**63 - 1", :i64},
    {"2**63", "2**64 - 1", :u64},
    {"2**64", "2**127 - 1", "{} doesn't fit in an UInt64, try using the suffix i128"},
    {"2**127", "2**128 - 1", "{} doesn't fit in an UInt64, try using the suffix u128"},
    {"2**128", nil, "{} doesn't fit in an UInt64"},
  ])
  [:i8, :i16, :i32, :i64, :i128].each do |suf|
    size = suf.to_s[1..].to_i
    test_cases(suf.to_s, [
      {nil, "-2**#{size - 1} - 1", "{} doesn't fit in an Int#{size}"},
      {"-2**#{size - 1}", "2**#{size - 1} - 1", suf},
      {"2**#{size - 1}", nil, "{} doesn't fit in an Int#{size}"},
    ])
  end
  [:u8, :u16, :u32, :u64, :u128].each do |suf|
    size = suf.to_s[1..].to_i
    test_cases(suf.to_s, [
      {nil, "-1", "Invalid negative value {} for UInt#{size}"},
      {"0", "2**#{size} - 1", suf},
      {"2**#{size}", nil, "{} doesn't fit in an UInt#{size}"},
    ])
  end
end

private def it_lexes_char(string, value)
  it "lexes #{string}" do
    lexer = Lexer.new string
    token = lexer.next_token
    token.type.should eq(:CHAR)
    token.value.as(Char).should eq(value)
  end
end

private def it_lexes_string(string, value)
  it "lexes #{string}" do
    lexer = Lexer.new string
    token = lexer.next_token
    token.type.should eq(:DELIMITER_START)

    token = lexer.next_string_token(token.delimiter_state)
    token.value.should eq(value)
  end
end

private def it_lexes_operators(ops)
  ops.each do |op|
    it_lexes op.to_s, op, slash_is_regex: false
  end
end

private def it_lexes_const(value)
  it_lexes value, :CONST, value
end

private def it_lexes_instance_var(value)
  it_lexes value, :INSTANCE_VAR, value
end

private def it_lexes_class_var(value)
  it_lexes value, :CLASS_VAR, value
end

private def it_lexes_globals(globals)
  it_lexes_many globals, :GLOBAL
end

private def it_lexes_symbols(symbols)
  symbols.each do |symbol|
    value = symbol[1, symbol.size - 1]
    value = value[1, value.size - 2] if value.starts_with?('"')
    it_lexes symbol, :SYMBOL, value
  end
end

private def it_lexes_global_match_data_index(globals)
  globals.each do |global|
    it_lexes global, :GLOBAL_MATCH_DATA_INDEX, global[1, global.size - 1]
  end
end

describe "Lexer" do
  it_lexes "", :EOF
  it_lexes " ", :SPACE
  it_lexes "\t", :SPACE
  it_lexes "\n", :NEWLINE
  it_lexes "\n\n\n", :NEWLINE
  it_lexes "_", :UNDERSCORE
  it_lexes_keywords [:def, :if, :else, :elsif, :end, :true, :false, :class, :module, :include,
                     :extend, :while, :until, :nil, :do, :yield, :return, :unless, :next, :break,
                     :begin, :lib, :fun, :type, :struct, :union, :enum, :macro, :out, :require,
                     :case, :when, :select, :then, :of, :abstract, :rescue, :ensure, :is_a?, :alias,
                     :pointerof, :sizeof, :instance_sizeof, :offsetof, :as, :as?, :typeof, :for, :in,
                     :with, :self, :super, :private, :protected, :asm, :uninitialized, :nil?,
                     :annotation, :verbatim]
  it_lexes_idents ["ident", "something", "with_underscores", "with_1", "foo?", "bar!", "fooBar",
                   "❨╯°□°❩╯︵┻━┻"]
  it_lexes_idents ["def?", "if?", "else?", "elsif?", "end?", "true?", "false?", "class?", "while?",
                   "do?", "yield?", "return?", "unless?", "next?", "break?", "begin?"]
  it_lexes_idents ["def!", "if!", "else!", "elsif!", "end!", "true!", "false!", "class!", "while!",
                   "nil!", "do!", "yield!", "return!", "unless!", "next!", "break!", "begin!"]
  it_lexes_i32 ["1", ["0i32", "0"], ["1hello", "1"], "+1", "-1", "1234", "+1234", "-1234",
                ["1.foo", "1"], ["1_000", "1000"], ["100_000", "100000"]]
  it_lexes_i64 [["1i64", "1"], ["1_i64", "1"], ["1i64hello", "1"], ["+1_i64", "+1"], ["-1_i64", "-1"]]
  it_lexes_i128 [["1i128", "1"], ["1_i128", "1"], ["1i128hello", "1"], ["+1_i128", "+1"], ["-1_i128", "-1"]]
  it_lexes_f32 [["0f32", "0"], ["0_f32", "0"], ["1.0f32", "1.0"], ["1.0f32hello", "1.0"],
                ["+1.0f32", "+1.0"], ["-1.0f32", "-1.0"], ["-0.0f32", "-0.0"], ["1_234.567_890_f32", "1234.567890"]]
  it_lexes_f64 ["1.0", ["1.0hello", "1.0"], "+1.0", "-1.0", ["1_234.567_890", "1234.567890"]]
  it_lexes_f32 [["1e+23_f32", "1e+23"], ["1.2e+23_f32", "1.2e+23"]]
  it_lexes_f64 ["1e23", "1e-23", "1e+23", "1.2e+23", ["1e23f64", "1e23"], ["1.2e+23_f64", "1.2e+23"], "0e40", "2e01", ["2_e2", "2e2"], "1E40"]

  it_lexes_number :i8, ["1i8", "1"]
  it_lexes_number :i8, ["1_i8", "1"]

  it_lexes_number :i16, ["1i16", "1"]
  it_lexes_number :i16, ["1_i16", "1"]

  it_lexes_number :i32, ["1i32", "1"]
  it_lexes_number :i32, ["1_i32", "1"]

  it_lexes_number :i64, ["1i64", "1"]
  it_lexes_number :i64, ["1_i64", "1"]

  it_lexes_number :u8, ["1u8", "1"]
  it_lexes_number :u8, ["1_u8", "1"]

  it_lexes_number :u16, ["1u16", "1"]
  it_lexes_number :u16, ["1_u16", "1"]

  it_lexes_number :u32, ["1u32", "1"]
  it_lexes_number :u32, ["1_u32", "1"]

  it_lexes_number :u64, ["1u64", "1"]
  it_lexes_number :u64, ["1_u64", "1"]

  it_lexes_number :u128, ["1u128", "1"]
  it_lexes_number :u128, ["1_u128", "1"]

  it_lexes_number :f32, ["1f32", "1"]
  it_lexes_number :f32, ["1.0f32", "1.0"]

  it_lexes_number :f64, ["1f64", "1"]
  it_lexes_number :f64, ["1.0f64", "1.0"]

  it_lexes_number :i32, ["0b1010", "10"]
  it_lexes_number :i32, ["+0b1010", "+10"]
  it_lexes_number :i32, ["-0b1010", "-10"]

  it_lexes_number :i32, ["0xFFFF", "65535"]
  it_lexes_number :i32, ["0xabcdef", "11259375"]
  it_lexes_number :i32, ["+0xFFFF", "+65535"]
  it_lexes_number :i32, ["-0xFFFF", "-65535"]

  it_lexes_number :i64, ["0x80000001", "2147483649"]
  it_lexes_number :i64, ["-0x80000001", "-2147483649"]
  it_lexes_number :i64, ["0xFFFFFFFF", "4294967295"]
  it_lexes_number :i64, ["-0xFFFFFFFF", "-4294967295"]

  it_lexes_number :u64, ["0xFFFF_u64", "65535"]

  it_lexes_i32 [["0o123", "83"], ["-0o123", "-83"], ["+0o123", "+83"]]
  it_lexes_f64 [["0.5", "0.5"], ["+0.5", "+0.5"], ["-0.5", "-0.5"]]
  it_lexes_i64 [["0o123_i64", "83"], ["0x1_i64", "1"], ["0b1_i64", "1"]]

  it_lexes_i64 ["2147483648", "-2147483649"]
  it_lexes_i64 [["2147483648.foo", "2147483648"]]
  it_lexes_u64 ["18446744073709551615", "14146167139683460000", "9223372036854775808"]
  it_lexes_number :u64, ["10000000000000000000_u64", "10000000000000000000"]

  it_lexes_i64 [["0x3fffffffffffffff", "4611686018427387903"]]
  it_lexes_i64 [["-0x8000000000000000_i64", "-9223372036854775808"]]
  it_lexes_i64 ["-9223372036854775808", "9223372036854775807"]
  it_lexes_u64 [["0xffffffffffffffff", "18446744073709551615"]]

  it_lexes_number :i32, ["+0", "+0"]
  it_lexes_number :i32, ["-0", "-0"]

  it_lexes_number :i32, ["0", "0"]
  it_lexes_number :i32, ["0_i32", "0"]
  it_lexes_number :i8, ["0i8", "0"]

  it_lexes_char "'a'", 'a'
  it_lexes_char "'\\a'", '\a'
  it_lexes_char "'\\b'", '\b'
  it_lexes_char "'\\n'", '\n'
  it_lexes_char "'\\t'", '\t'
  it_lexes_char "'\\v'", '\v'
  it_lexes_char "'\\f'", '\f'
  it_lexes_char "'\\r'", '\r'
  it_lexes_char "'\\0'", '\0'
  it_lexes_char "'\\0'", '\0'
  it_lexes_char "'\\''", '\''
  it_lexes_char "'\\\\'", '\\'
  assert_syntax_error "'", "unterminated char literal"
  assert_syntax_error "'\\", "unterminated char literal"
  it_lexes_operators [:"=", :"<", :"<=", :">", :">=", :"+", :"-", :"*", :"/", :"//", :"(", :")",
                      :"==", :"!=", :"=~", :"!", :",", :".", :"..", :"...", :"&&", :"||",
                      :"|", :"{", :"}", :"?", :":", :"+=", :"-=", :"*=", :"/=", :"%=", :"//=", :"&=",
                      :"|=", :"^=", :"**=", :"<<", :">>", :"%", :"&", :"|", :"^", :"**", :"<<=",
                      :">>=", :"~", :"[]", :"[]=", :"[", :"]", :"::", :"<=>", :"=>", :"||=",
                      :"&&=", :"===", :";", :"->", :"[]?", :"{%", :"{{", :"%}", :"@[", :"!~",
                      :"&+", :"&-", :"&*", :"&**", :"&+=", :"&-=", :"&*="]
  it_lexes "!@foo", :"!"
  it_lexes "+@foo", :"+"
  it_lexes "-@foo", :"-"
  it_lexes "&+@foo", :"&+"
  it_lexes "&-@foo", :"&-"
  it_lexes_const "Foo"
  it_lexes_instance_var "@foo"
  it_lexes_class_var "@@foo"
  it_lexes_globals ["$foo", "$FOO", "$_foo", "$foo123"]
  it_lexes_symbols [":foo", ":foo!", ":foo?", ":foo=", ":\"foo\"", ":かたな", ":+", ":-", ":*", ":/", "://",
                    ":==", ":<", ":<=", ":>", ":>=", ":!", ":!=", ":=~", ":!~", ":&", ":|",
                    ":^", ":~", ":**", ":>>", ":<<", ":%", ":[]", ":[]?", ":[]=", ":<=>", ":===",
                    ":&+", ":&-", ":&*", ":&**"]

  it_lexes_global_match_data_index ["$1", "$10", "$1?", "$23?"]

  it_lexes "$~", :"$~"
  it_lexes "$?", :"$?"

  assert_syntax_error "128_i8", "128 doesn't fit in an Int8"
  assert_syntax_error "-129_i8", "-129 doesn't fit in an Int8"
  assert_syntax_error "256_u8", "256 doesn't fit in an UInt8"
  assert_syntax_error "-1_u8", "Invalid negative value -1 for UInt8"

  assert_syntax_error "32768_i16", "32768 doesn't fit in an Int16"
  assert_syntax_error "-32769_i16", "-32769 doesn't fit in an Int16"
  assert_syntax_error "65536_u16", "65536 doesn't fit in an UInt16"
  assert_syntax_error "-1_u16", "Invalid negative value -1 for UInt16"

  assert_syntax_error "2147483648_i32", "2147483648 doesn't fit in an Int32"
  assert_syntax_error "-2147483649_i32", "-2147483649 doesn't fit in an Int32"
  assert_syntax_error "4294967296_u32", "4294967296 doesn't fit in an UInt32"
  assert_syntax_error "-1_u32", "Invalid negative value -1 for UInt32"

  assert_syntax_error "9223372036854775808_i64", "9223372036854775808 doesn't fit in an Int64"
  assert_syntax_error "-9223372036854775809_i64", "-9223372036854775809 doesn't fit in an Int64"
  assert_syntax_error "118446744073709551616_u64", "118446744073709551616 doesn't fit in an UInt64"
  assert_syntax_error "18446744073709551616_u64", "18446744073709551616 doesn't fit in an UInt64"
  assert_syntax_error "-1_u64", "Invalid negative value -1 for UInt64"
  assert_syntax_error "-0_u64", "Invalid negative value -0 for UInt64"
  assert_syntax_error "-0u64", "Invalid negative value -0 for UInt64"

  assert_syntax_error "18446744073709551616_i32", "18446744073709551616 doesn't fit in an Int32"
  assert_syntax_error "9999999999999999999_i32", "9999999999999999999 doesn't fit in an Int32"

  assert_syntax_error "-9999999999999999999", "-9999999999999999999 doesn't fit in an Int64, try using the suffix i128"
  assert_syntax_error "-99999999999999999999", "-99999999999999999999 doesn't fit in an Int64, try using the suffix i128"
  assert_syntax_error "-11111111111111111111", "-11111111111111111111 doesn't fit in an Int64, try using the suffix i128"
  assert_syntax_error "-9223372036854775809", "-9223372036854775809 doesn't fit in an Int64, try using the suffix i128"
  assert_syntax_error "118446744073709551616", "118446744073709551616 doesn't fit in an UInt64, try using the suffix i128"
  assert_syntax_error "18446744073709551616", "18446744073709551616 doesn't fit in an UInt64, try using the suffix i128"

  assert_syntax_error "340282366920938463463374607431768211456", "340282366920938463463374607431768211456 doesn't fit in an UInt64"
  assert_syntax_error "-170141183460469231731687303715884105729", "-170141183460469231731687303715884105729 doesn't fit in an Int64"
  assert_syntax_error "-999999999999999999999999999999999999999", "-999999999999999999999999999999999999999 doesn't fit in an Int64"

  assert_syntax_error "0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF", "0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF doesn't fit in an UInt64"
  assert_syntax_error "0o7777777777777777777777777777777777777777777777777", "0o7777777777777777777777777777777777777777777777777 doesn't fit in an UInt64"
  assert_syntax_error "-0o7777777777777777777777777777777777777777777777777", "-0o7777777777777777777777777777777777777777777777777 doesn't fit in an Int64"

  it_lexes_number :i128, ["9223372036854775808_i128", "9223372036854775808"]
  it_lexes_number :i128, ["-9223372036854775809_i128", "-9223372036854775809"]
  it_lexes_number :u128, ["118446744073709551616_u128", "118446744073709551616"]
  it_lexes_number :u128, ["18446744073709551616_u128", "18446744073709551616"]
  it_lexes_number :i128, ["170141183460469231731687303715884105727_i128", "170141183460469231731687303715884105727"]
  it_lexes_number :u128, ["170141183460469231731687303715884105728_u128", "170141183460469231731687303715884105728"]
  it_lexes_number :u128, ["340282366920938463463374607431768211455_u128", "340282366920938463463374607431768211455"]
  it_lexes_number :u128, ["0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF_u128", "340282366920938463463374607431768211455"]
  it_lexes_number :i128, ["-0x80000000000000000000000000000000_i128", "-170141183460469231731687303715884105728"]
  assert_syntax_error "0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF", "0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF doesn't fit in an UInt64, try using the suffix u128"
  assert_syntax_error "-0x80000000000000000000000000000000", "-0x80000000000000000000000000000000 doesn't fit in an Int64, try using the suffix i128"
  assert_syntax_error "-0x80000000000000000000000000000001", "-0x80000000000000000000000000000001 doesn't fit in an Int64"
  assert_syntax_error "-1_u128", "Invalid negative value -1 for UInt128"

  assert_syntax_error "1__1", "consecutive underscores in numbers aren't allowed"
  assert_syntax_error "-3_", "trailing '_' in number"
  assert_syntax_error "0b_10", "unexpected '_' in number"
  assert_syntax_error "10e_10", "unexpected '_' in number"
  assert_syntax_error "1_.1", "unexpected '_' in number"
  assert_syntax_error "-0e_12", "unexpected '_' in number"

  assert_syntax_error "0_12", "octal constants should be prefixed with 0o"
  assert_syntax_error "0123", "octal constants should be prefixed with 0o"
  assert_syntax_error "00", "octal constants should be prefixed with 0o"
  assert_syntax_error "01_i64", "octal constants should be prefixed with 0o"

  assert_syntax_error "0xFF_i8", "0xFF doesn't fit in an Int8"
  assert_syntax_error "0o200_i8", "0o200 doesn't fit in an Int8"
  assert_syntax_error "0b10000000_i8", "0b10000000 doesn't fit in an Int8"

  # 2**31 - 1
  it_lexes_i32 [["0x7fffffff", "2147483647"], ["0o17777777777", "2147483647"], ["0b1111111111111111111111111111111", "2147483647"]]
  it_lexes_i32 [["0x7fffffff_i32", "2147483647"], ["0o17777777777_i32", "2147483647"], ["0b1111111111111111111111111111111_i32", "2147483647"]]
  # 2**32 - 1
  it_lexes_i64 [["0xffffffff", "4294967295"], ["0o37777777777", "4294967295"], ["0b11111111111111111111111111111111", "4294967295"]]
  # 2**32
  it_lexes_i64 [["0x100000000", "4294967296"], ["0o40000000000", "4294967296"], ["0b100000000000000000000000000000000", "4294967296"]]
  assert_syntax_error "0x100000000i32", "0x100000000 doesn't fit in an Int32"
  assert_syntax_error "0o40000000000i32", "0o40000000000 doesn't fit in an Int32"
  assert_syntax_error "0b100000000000000000000000000000000i32", "0b100000000000000000000000000000000 doesn't fit in an Int32"
  # 2**63 - 1
  it_lexes_i64 [["0x7fffffffffffffff", "9223372036854775807"], ["0o777777777777777777777", "9223372036854775807"], ["0b111111111111111111111111111111111111111111111111111111111111111", "9223372036854775807"]]
  # 2**63
  it_lexes_u64 [["0x8000000000000000", "9223372036854775808"], ["0o1000000000000000000000", "9223372036854775808"], ["0b1000000000000000000000000000000000000000000000000000000000000000", "9223372036854775808"]]
  assert_syntax_error "0x8000000000000000i64", "0x8000000000000000 doesn't fit in an Int64"
  assert_syntax_error "0o1000000000000000000000i64", "0o1000000000000000000000 doesn't fit in an Int64"
  assert_syntax_error "0b1000000000000000000000000000000000000000000000000000000000000000i64", "0b1000000000000000000000000000000000000000000000000000000000000000 doesn't fit in an Int64"
  # 2**64 - 1
  it_lexes_u64 [["0xffff_ffff_ffff_ffff", "18446744073709551615"], ["0o177777_77777777_77777777", "18446744073709551615"], ["0b11111111_11111111_11111111_11111111_11111111_11111111_11111111_11111111", "18446744073709551615"]]
  it_lexes_u64 [["0x00ffffffffffffffff", "18446744073709551615"], ["0o001777777777777777777777", "18446744073709551615"], ["0b001111111111111111111111111111111111111111111111111111111111111111", "18446744073709551615"]]
  # 2**64
  it_lexes_number :i128, ["0x10000_0000_0000_0000_i128", "18446744073709551616"]
  assert_syntax_error "0x10000_0000_0000_0000_u64", "0x10000_0000_0000_0000 doesn't fit in an UInt64"
  assert_syntax_error "0xfffffffffffffffff_u64", "0xfffffffffffffffff doesn't fit in an UInt64"
  assert_syntax_error "0o200000_00000000_00000000_u64", "0o200000_00000000_00000000 doesn't fit in an UInt64"
  assert_syntax_error "0b100000000_00000000_00000000_00000000_00000000_00000000_00000000_00000000_u64", "0b100000000_00000000_00000000_00000000_00000000_00000000_00000000_00000000 doesn't fit in an UInt64"
  # Very large
  assert_syntax_error "0x1afafafafafafafafafafafu64", "0x1afafafafafafafafafafaf doesn't fit in an UInt64"
  assert_syntax_error "0x1afafafafafafafafafafafi32", "0x1afafafafafafafafafafaf doesn't fit in an Int32"
  assert_syntax_error "0o1234567123456712345671234567u64", "0o1234567123456712345671234567 doesn't fit in an UInt64"
  assert_syntax_error "0o12345671234567_12345671234567_i8", "0o12345671234567_12345671234567 doesn't fit in an Int8"
  assert_syntax_error "0b100000000000000000000000000000000000000000000000000000000000000000u64", "0b100000000000000000000000000000000000000000000000000000000000000000 doesn't fit in an UInt64"

  it_lexes_i64 [["0o700000000000000000000", "8070450532247928832"]]
  it_lexes_u64 [["0o1000000000000000000000", "9223372036854775808"]]

  assert_syntax_error "4f33", "invalid float suffix"
  assert_syntax_error "4f65", "invalid float suffix"
  assert_syntax_error "4f22", "invalid float suffix"
  assert_syntax_error "4i33", "invalid int suffix"
  assert_syntax_error "4i65", "invalid int suffix"
  assert_syntax_error "4i22", "invalid int suffix"
  assert_syntax_error "4i3", "invalid int suffix"
  assert_syntax_error "4i12", "invalid int suffix"
  assert_syntax_error "4u33", "invalid uint suffix"
  assert_syntax_error "4u65", "invalid uint suffix"
  assert_syntax_error "4u22", "invalid uint suffix"
  assert_syntax_error "4u3", "invalid uint suffix"
  assert_syntax_error "4u12", "invalid uint suffix"
  # Tests for #8782
  assert_syntax_error "4F32", %(unexpected token: "F32")
  assert_syntax_error "4F64", %(unexpected token: "F64")
  assert_syntax_error "0F32", %(unexpected token: "F32")

  assert_syntax_error "4.0_u32", "Invalid suffix u32 for decimal number"
  assert_syntax_error "2e8i8", "Invalid suffix i8 for decimal number"

  assert_syntax_error ".42", ".1 style number literal is not supported, put 0 before dot"
  assert_syntax_error "-.42", ".1 style number literal is not supported, put 0 before dot"

  assert_syntax_error "2e", "unexpected token: \"e\""
  assert_syntax_error "2ef32", "unexpected token: \"ef32\""
  assert_syntax_error "2e+_2", "unexpected '_' in number"

  it "lexes not instance var" do
    lexer = Lexer.new "!@foo"
    token = lexer.next_token
    token.type.should eq(:"!")
    token = lexer.next_token
    token.type.should eq(:INSTANCE_VAR)
    token.value.should eq("@foo")
  end

  it "lexes space after keyword" do
    lexer = Lexer.new "end 1"
    token = lexer.next_token
    token.type.should eq(:IDENT)
    token.value.should eq(:end)
    token = lexer.next_token
    token.type.should eq(:SPACE)
  end

  it "lexes space after char" do
    lexer = Lexer.new "'a' "
    token = lexer.next_token
    token.type.should eq(:CHAR)
    token.value.should eq('a')
    token = lexer.next_token
    token.type.should eq(:SPACE)
  end

  it "lexes comment and token" do
    lexer = Lexer.new "# comment\n="
    token = lexer.next_token
    token.type.should eq(:NEWLINE)
    token = lexer.next_token
    token.type.should eq(:"=")
  end

  it "lexes comment at the end" do
    lexer = Lexer.new "# comment"
    token = lexer.next_token
    token.type.should eq(:EOF)
  end

  it "lexes __LINE__" do
    lexer = Lexer.new "__LINE__"
    token = lexer.next_token
    token.type.should eq(:__LINE__)
  end

  it "lexes __FILE__" do
    lexer = Lexer.new "__FILE__"
    lexer.filename = "foo"
    token = lexer.next_token
    token.type.should eq(:__FILE__)
  end

  it "lexes __DIR__" do
    lexer = Lexer.new "__DIR__"
    token = lexer.next_token
    token.type.should eq(:__DIR__)
  end

  it "lexes dot and ident" do
    lexer = Lexer.new ".read"
    token = lexer.next_token
    token.type.should eq(:".")
    token = lexer.next_token
    token.type.should eq(:IDENT)
    token.value.should eq("read")
    token = lexer.next_token
    token.type.should eq(:EOF)
  end

  assert_syntax_error "/foo", "Unterminated regular expression"
  assert_syntax_error "/\\", "Unterminated regular expression"
  assert_syntax_error ":\"foo", "unterminated quoted symbol"

  it "lexes utf-8 char" do
    lexer = Lexer.new "'á'"
    token = lexer.next_token
    token.type.should eq(:CHAR)
    token.value.as(Char).ord.should eq(225)
  end

  it "lexes utf-8 multibyte char" do
    lexer = Lexer.new "'日'"
    token = lexer.next_token
    token.type.should eq(:CHAR)
    token.value.as(Char).ord.should eq(26085)
  end

  it "doesn't raise if slash r with slash n" do
    lexer = Lexer.new("\r\n1")
    token = lexer.next_token
    token.type.should eq(:NEWLINE)
    token = lexer.next_token
    token.type.should eq(:NUMBER)
  end

  it "doesn't raise if many slash r with slash n" do
    lexer = Lexer.new("\r\n\r\n\r\n1")
    token = lexer.next_token
    token.type.should eq(:NEWLINE)
    token = lexer.next_token
    token.type.should eq(:NUMBER)
  end

  assert_syntax_error "\r1", "expected '\\n' after '\\r'"

  it "lexes char with unicode codepoint" do
    lexer = Lexer.new "'\\uFEDA'"
    token = lexer.next_token
    token.type.should eq(:CHAR)
    token.value.as(Char).ord.should eq(0xFEDA)
  end

  it "lexes char with unicode codepoint and curly with zeros" do
    lexer = Lexer.new "'\\u{0}'"
    token = lexer.next_token
    token.type.should eq(:CHAR)
    token.value.as(Char).ord.should eq(0)
  end

  it "lexes char with unicode codepoint and curly" do
    lexer = Lexer.new "'\\u{A5}'"
    token = lexer.next_token
    token.type.should eq(:CHAR)
    token.value.as(Char).ord.should eq(0xA5)
  end

  it "lexes char with unicode codepoint and curly with six hex digits" do
    lexer = Lexer.new "'\\u{10FFFF}'"
    token = lexer.next_token
    token.type.should eq(:CHAR)
    token.value.as(Char).ord.should eq(0x10FFFF)
  end

  it "lexes float then zero (bug)" do
    lexer = Lexer.new "2.5 0"
    lexer.next_token.number_kind.should eq(:f64)
    lexer.next_token.type.should eq(:SPACE)
    token = lexer.next_token
    token.type.should eq(:NUMBER)
    token.number_kind.should eq(:i32)
  end

  it "lexes symbol with quote" do
    lexer = Lexer.new %(:"\\"")
    token = lexer.next_token
    token.type.should eq(:SYMBOL)
    token.value.should eq("\"")
  end

  it "lexes symbol with backslash (#2187)" do
    lexer = Lexer.new %(:"\\\\")
    token = lexer.next_token
    token.type.should eq(:SYMBOL)
    token.value.should eq("\\")
  end

  it "lexes symbol followed by !=" do
    lexer = Lexer.new ":a!=:a"
    token = lexer.next_token
    token.type.should eq(:SYMBOL)
    token.value.should eq("a")
    token = lexer.next_token
    token.type.should eq(:"!=")
    token = lexer.next_token
    token.type.should eq(:SYMBOL)
    token.value.should eq("a")
  end

  it "lexes symbol followed by ==" do
    lexer = Lexer.new ":a==:a"
    token = lexer.next_token
    token.type.should eq(:SYMBOL)
    token.value.should eq("a")
    token = lexer.next_token
    token.type.should eq(:"==")
    token = lexer.next_token
    token.type.should eq(:SYMBOL)
    token.value.should eq("a")
  end

  it "lexes symbol followed by ===" do
    lexer = Lexer.new ":a===:a"
    token = lexer.next_token
    token.type.should eq(:SYMBOL)
    token.value.should eq("a")
    token = lexer.next_token
    token.type.should eq(:"===")
    token = lexer.next_token
    token.type.should eq(:SYMBOL)
    token.value.should eq("a")
  end

  it "lexes != after identifier (#4815)" do
    lexer = Lexer.new("some_method!=5")
    token = lexer.next_token
    token.type.should eq(:IDENT)
    token.value.should eq("some_method")
    token = lexer.next_token
    token.type.should eq(:"!=")
    token = lexer.next_token
    token.type.should eq(:NUMBER)
  end

  assert_syntax_error "'\\uFEDZ'", "expected hexadecimal character in unicode escape"
  assert_syntax_error "'\\u{}'", "expected hexadecimal character in unicode escape"
  assert_syntax_error "'\\u{110000}'", "invalid unicode codepoint (too large)"
  assert_syntax_error "'\\uD800'", "invalid unicode codepoint (surrogate half)"
  assert_syntax_error "'\\uDFFF'", "invalid unicode codepoint (surrogate half)"
  assert_syntax_error "'\\u{D800}'", "invalid unicode codepoint (surrogate half)"
  assert_syntax_error "'\\u{DFFF}'", "invalid unicode codepoint (surrogate half)"
  assert_syntax_error ":+1", "unexpected token"

  assert_syntax_error "'\\1'", "invalid char escape sequence"

  it_lexes_string %("\\1"), String.new(Bytes[1])
  it_lexes_string %("\\4"), String.new(Bytes[4])
  it_lexes_string %("\\10"), String.new(Bytes[8])
  it_lexes_string %("\\110"), String.new(Bytes[72])
  it_lexes_string %("\\8"), "8"
  assert_syntax_error %("\\400"), "octal value too big"

  it_lexes_string %("\\x12"), String.new(Bytes[0x12])
  it_lexes_string %("\\xFF"), String.new(Bytes[0xFF])
  assert_syntax_error %("\\xz"), "invalid hex escape"
  assert_syntax_error %("\\x1z"), "invalid hex escape"

  assert_syntax_error %("hi\\)
end
